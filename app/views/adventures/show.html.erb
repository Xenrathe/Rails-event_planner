<% creator_mode = false %>
<% if (current_user && @adventure.creator.id == current_user.id) %>
  <% creator_mode = true %>
<% end %>

<div class="Adventure">
  <%= render 'shared/ruleset_image', image_size: "400x200", adventure: @adventure %>
  <h1><%= @adventure.name %></h1>
  <h3>Hosted by: <%= link_to @adventure.creator.username, user_path(@adventure.creator) %> </h3>
  <% if !@adventure.is_private || creator_mode %>
    <h2>Occuring on <%= @adventure.date %></h2>
    <% if !@adventure.module.nil? || @adventure.module != "" %>
      <h3>Module: <%= @adventure.module %> </h3>
    <% end %>
    <h3>Platform: <%= @adventure.platform %> </h3>
    <% if @adventure.platform == "InPersonPublic" || creator_mode %>
      <h3>Address: <%= @adventure.address %> <% if creator_mode && @adventure.platform == "InPersonHome" %>(Not public)<% end %></h3>
    <% end %>
    <h3>Level: <%= @adventure.min_level%> to <%= @adventure.max_level %></h3>
    <h3>Minimum Age: <%= @adventure.min_age %></h3>
    <p><%= @adventure.description %>
    <hr>
    <h2>Attendees (<%= @adventure.attendees.count%> / <%= @adventure.max_seats %>):</h2><ul>
      <% @adventure.attendees.each do |attendee| %>
        <li><%= link_to attendee.name, character_path(attendee) %>, level <%= attendee.level %> <%= attendee.character_class %> <% if creator_mode %> (<%= attendee.user.email %>) <% end %>
      <% end %>
    </ul>

    <% if user_signed_in? && !creator_mode && !current_user.active_character.nil? && 
          current_user.active_character.level >= @adventure.min_level && 
          current_user.active_character.level <= @adventure.max_level && 
          current_user.birthdate + @adventure.min_age.years < Time.now && 
          @adventure.attendees.count < @adventure.max_seats %>
      <%= form_for @adventure, url: attend_adventure_path(@adventure), method: :post, remote: true do |f| %>
        <% attend_text = @adventure.attendees.include?(current_user.active_character) ? 'Unattend Adventure' : 'Attend Adventure' %>
        <%= f.submit attend_text, class: 'btn' %>
      <% end %>
      <% if flash[:alert] %><div class="flash alert"><%= flash[:alert] %></div>
<% end %>
    <% elsif creator_mode %>
      <%= form_for @adventure, url: adventure_path(@adventure), method: :patch do |f| %>
        <% if @adventure.is_private %>
          <%= f.hidden_field :is_private, value: false %>
          <%= f.submit 'Make Public', class: 'btn' %>
        <% else %>
          <%= f.hidden_field :is_private, value: true %>
          <%= f.submit 'Make Private', class: 'btn' %>
        <% end %>
      <% end %>
      <%= button_to "Edit", edit_adventure_path(@adventure), class: 'btn', method: :get %>
      <%= button_to "Delete", adventure_path(@adventure), class: 'btn', method: :delete, data: { turbo_method: :delete, turbo_confirm: 'Are you sure you want to delete this adventure?' } %>
    <% end %>
  <% else %>
    <h2>Adventure is currently marked private</h2>
  <% end %>
</div>